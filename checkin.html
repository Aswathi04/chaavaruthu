 <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VolunteerFlow</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg:        #F5F0E8;
      --surface:   #FDFAF5;
      --border:    #E2D9C8;
      --ink:       #2C2416;
      --ink-soft:  #7A6E5F;
      --ink-faint: #B5A898;
      --energizing:#E8874A;
      --neutral:   #7FAF78;
      --draining:  #5C7A9E;
      --accent:    #E8874A;
      --rim:       #D4C9B5;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background-color: var(--bg);
      color: var(--ink);
      line-height: 1.7;
      min-height: 100vh;
    }

    /* Subtle paper texture via layered radial gradients */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse at 20% 20%, rgba(232,135,74,0.06) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 80%, rgba(92,122,158,0.06) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      max-width: 620px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 48px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .logo {
      font-family: 'Lora', serif;
      font-size: 18px;
      font-weight: 600;
      letter-spacing: -0.3px;
      color: var(--ink);
    }
    .logo span { color: var(--accent); }

    .vol-id-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 6px 14px;
    }
    .vol-id-wrapper label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--ink-faint);
      font-weight: 500;
    }
    #volIdInput {
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: var(--ink);
      border: none;
      background: transparent;
      width: 80px;
      outline: none;
    }

    /* â”€â”€ GREETING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .greeting-block {
      margin-bottom: 40px;
    }
    .greeting-block h1 {
      font-family: 'Lora', serif;
      font-size: 36px;
      font-weight: 600;
      line-height: 1.2;
      margin-bottom: 6px;
      letter-spacing: -0.5px;
    }
    .greeting-block p {
      font-size: 15px;
      color: var(--ink-soft);
      font-style: italic;
      font-family: 'Lora', serif;
    }

    /* â”€â”€ CAPACITY ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .capacity-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 32px;
    }
    .capacity-label {
      font-size: 13px;
      color: var(--ink-soft);
    }
    .capacity-label strong {
      display: block;
      font-size: 15px;
      color: var(--ink);
      font-weight: 600;
    }
    .capacity-input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #capacityInput {
      font-family: 'Lora', serif;
      font-size: 22px;
      font-weight: 600;
      color: var(--ink);
      width: 52px;
      text-align: center;
      border: none;
      background: transparent;
      outline: none;
      border-bottom: 2px solid var(--border);
    }
    .capacity-unit { font-size: 13px; color: var(--ink-faint); }

    /* â”€â”€ PLATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plate-section {
      text-align: center;
      margin-bottom: 36px;
      animation: fadeUp 0.6s ease both;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .plate-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--ink-faint);
      font-weight: 600;
      margin-bottom: 16px;
    }
    .plate-container { display: inline-block; position: relative; }
    #arc-details {
      margin-top: 14px;
      font-size: 13px;
      color: var(--ink-soft);
      min-height: 20px;
      transition: opacity 0.3s;
    }

    /* â”€â”€ TASKS SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tasks-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .tasks-header h2 {
      font-family: 'Lora', serif;
      font-size: 20px;
      font-weight: 600;
    }
    .tasks-week-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--ink-faint);
    }

    datalist { display: none; }

    /* â”€â”€ TASK ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-row {
      display: grid;
      grid-template-columns: 1fr auto auto auto auto;
      gap: 8px;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      animation: slideIn 0.2s ease both;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-8px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    .task-inputs {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .task-name-input,
    .task-org-input {
      font-family: 'DM Sans', sans-serif;
      border: none;
      background: transparent;
      outline: none;
      color: var(--ink);
      padding: 2px 0;
    }
    .task-name-input {
      font-size: 15px;
      font-weight: 500;
    }
    .task-name-input::placeholder { color: var(--ink-faint); font-weight: 400; }
    .task-org-input {
      font-size: 12px;
      color: var(--ink-soft);
    }
    .task-org-input::placeholder { color: var(--ink-faint); }

    /* Hours nudge */
    .hours-control {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 10px;
    }
    .hours-control button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      color: var(--ink-soft);
      padding: 0 2px;
      line-height: 1;
      font-family: 'DM Sans', sans-serif;
      transition: color 0.15s;
    }
    .hours-control button:hover { color: var(--accent); }
    .hours-val {
      font-size: 13px;
      font-weight: 600;
      min-width: 24px;
      text-align: center;
      color: var(--ink);
    }

    /* Tag buttons */
    .tag-group { display: flex; gap: 4px; }
    .tag-btn {
      width: 32px; height: 32px;
      border-radius: 50%;
      border: 2px solid transparent;
      background: var(--surface);
      font-size: 15px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .tag-btn:hover { transform: scale(1.1); }
    .tag-btn.selected-energizing { background: rgba(232,135,74,0.15); border-color: var(--energizing); }
    .tag-btn.selected-neutral    { background: rgba(127,175,120,0.15); border-color: var(--neutral); }
    .tag-btn.selected-draining   { background: rgba(92,122,158,0.15); border-color: var(--draining); }

    .delete-btn {
      background: none;
      border: none;
      color: var(--ink-faint);
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      transition: color 0.15s;
    }
    .delete-btn:hover { color: #c0392b; }

    /* â”€â”€ ADD TASK BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-add {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: 1.5px dashed var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      width: 100%;
      margin-top: 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--ink-soft);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-add:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(232,135,74,0.04);
    }
    .btn-add-icon {
      width: 22px; height: 22px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
      line-height: 1;
      flex-shrink: 0;
    }

    /* â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .submit-area { margin-top: 32px; }
    .btn-submit {
      width: 100%;
      padding: 16px 24px;
      background: var(--ink);
      color: var(--bg);
      border: none;
      border-radius: 12px;
      font-family: 'Lora', serif;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: -0.2px;
      transition: all 0.2s;
    }
    .btn-submit:hover {
      background: #1a1408;
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(44,36,22,0.2);
    }

    /* â”€â”€ REFLECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .reflection-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px 32px;
      text-align: center;
      animation: fadeUp 0.5s ease both;
    }
    .reflection-card h2 {
      font-family: 'Lora', serif;
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .reflection-subhead {
      font-size: 14px;
      color: var(--ink-soft);
      font-style: italic;
      font-family: 'Lora', serif;
      margin-bottom: 24px;
    }
    #ref-raw-hours {
      font-family: 'Lora', serif;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    #ref-composition {
      font-size: 14px;
      color: var(--ink-soft);
      margin-bottom: 28px;
    }
    .insight-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px 24px;
      margin-bottom: 24px;
      text-align: left;
    }
    #ref-conditional {
      font-family: 'Lora', serif;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 6px;
      line-height: 1.5;
    }
    #ref-comparison {
      font-size: 13px;
      color: var(--ink-soft);
    }
    .btn-scroll {
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 20px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--ink-soft);
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-scroll:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ HISTORY / GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .history-section { margin-top: 56px; }
    .section-eyebrow {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      color: var(--ink-faint);
      font-weight: 600;
      margin-bottom: 4px;
    }
    .section-title {
      font-family: 'Lora', serif;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .section-desc {
      font-size: 13px;
      color: var(--ink-soft);
      font-style: italic;
      font-family: 'Lora', serif;
      margin-bottom: 24px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .calendar-cell {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 8px;
      text-align: center;
      transition: all 0.2s;
    }
    .calendar-cell.has-data {
      cursor: pointer;
    }
    .calendar-cell.has-data:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(44,36,22,0.1);
      border-color: var(--accent);
    }
    .calendar-date {
      font-size: 11px;
      color: var(--ink-faint);
      margin-top: 10px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(44,36,22,0.5);
      backdrop-filter: blur(4px);
      z-index: 50;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-content {
      background: var(--surface);
      border-radius: 20px;
      padding: 36px 32px;
      width: 100%; max-width: 420px;
      position: relative;
      box-shadow: 0 20px 60px rgba(44,36,22,0.25);
      animation: fadeUp 0.3s ease both;
    }
    .modal-close {
      position: absolute; top: 18px; right: 20px;
      background: none; border: none; font-size: 24px;
      color: var(--ink-faint); cursor: pointer;
      transition: color 0.15s;
    }
    .modal-close:hover { color: var(--ink); }
    #modal-title {
      font-family: 'Lora', serif;
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    #modal-subtitle {
      font-size: 13px;
      color: var(--ink-soft);
      margin-bottom: 24px;
    }
    .modal-tasks-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--ink-faint);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 12px;
    }
    #modal-task-list {
      font-size: 14px;
      max-height: 220px;
      overflow-y: auto;
    }
    .modal-task-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      color: var(--ink);
    }
    .modal-task-item:last-child { border-bottom: none; }
    .modal-task-org {
      font-size: 11px;
      color: var(--ink-faint);
      margin-left: 4px;
    }
    .modal-task-hrs {
      font-weight: 600;
      font-size: 13px;
      color: var(--ink-soft);
      flex-shrink: 0;
    }

    /* â”€â”€ DEMO BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .demo-btn-wrap {
      text-align: center;
      margin-top: 60px;
      padding-top: 24px;
      border-top: 1px dashed var(--border);
    }
    .demo-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--ink-faint);
      padding: 6px 14px;
      font-size: 11px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      transition: all 0.15s;
    }
    .demo-btn:hover { border-color: var(--ink-soft); color: var(--ink-soft); }

    .hidden { display: none !important; }

    /* Legend dots */
    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 14px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      color: var(--ink-soft);
    }
    .legend-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
    }
  </style>
</head>
<body>

<div class="page">

  <!-- HEADER -->
  <header class="site-header">
    <div class="logo">Volunteer<span>Flow</span></div>
    <div class="vol-id-wrapper">
      <label for="volIdInput">You are</label>
      <input type="text" id="volIdInput" value="Priya">
    </div>
  </header>

  <!-- FORM SECTION -->
  <div id="form-section">

    <div class="greeting-block">
      <h1 id="greeting">Hey Priya</h1>
      <p>What's on your plate this week?</p>
    </div>

    <!-- Capacity row -->
    <div class="capacity-row">
      <div class="capacity-label">
        <strong>My comfortable limit</strong>
        Hours I can give this week without stretching too thin
      </div>
      <div class="capacity-input-group">
        <input type="number" id="capacityInput" value="10" min="1" max="80">
        <span class="capacity-unit">hrs</span>
      </div>
    </div>

    <!-- Live plate -->
    <div class="plate-section">
      <div class="plate-label">Your plate, right now</div>
      <div class="plate-container" id="plate-viz"></div>
      <div id="arc-details" class="hidden"></div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--energizing)"></div> Energizing</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--neutral)"></div> Neutral</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--draining)"></div> Draining</div>
      </div>
    </div>

    <!-- Task list -->
    <div class="tasks-header">
      <h2>This week's work</h2>
      <span class="tasks-week-label" id="week-label"></span>
    </div>

    <datalist id="task-autocomplete"></datalist>
    <div id="task-list"></div>

    <button class="btn-add" id="btn-add-task">
      <span class="btn-add-icon">+</span>
      What else is on your plate?
    </button>

    <div class="submit-area">
      <button class="btn-submit" id="btn-submit">Save my week</button>
    </div>

  </div>

  <!-- REFLECTION SECTION -->
  <div id="reflection-section" class="hidden">
    <div class="reflection-card">
      <h2>How this week felt</h2>
      <p class="reflection-subhead">A moment to look at what you carried.</p>

      <div id="reflection-plate" style="display:flex; justify-content:center; margin: 24px 0;"></div>

      <p id="ref-raw-hours"></p>
      <p id="ref-composition"></p>

      <div class="insight-box">
        <p id="ref-conditional"></p>
        <p id="ref-comparison"></p>
      </div>

      <button class="btn-scroll" onclick="document.getElementById('history-section').scrollIntoView({behavior:'smooth'})">
        See my history
      </button>
    </div>
  </div>

  <!-- HISTORY / GALLERY -->
  <div class="history-section" id="history-section">
    <div class="section-eyebrow">Plate portrait gallery</div>
    <div class="section-title">Your weeks, in colour</div>
    <p class="section-desc">A visual record of what you've given. Click any week to revisit it.</p>
    <div class="calendar-grid" id="calendar-grid"></div>
  </div>

  <!-- DEMO BUTTON -->
  <div class="demo-btn-wrap">
    <button class="demo-btn" onclick="generateDemoHistory()">Inject demo history</button>
  </div>

</div>

<!-- HISTORY MODAL -->
<div id="history-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="document.getElementById('history-modal').classList.add('hidden')">&times;</button>
    <h2 id="modal-title">Week of ...</h2>
    <p id="modal-subtitle"></p>
    <div id="modal-plate" style="display:flex; justify-content:center; margin-bottom: 28px;"></div>
    <div class="modal-tasks-label">Tasks logged</div>
    <div id="modal-task-list"></div>
  </div>
</div>

<script>
  // â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const firebaseConfig = {
    apiKey: "AIzaSyCIuiidzKhTKrUDEIe34jeevCelWDttA3k",
    authDomain: "chaavaruthu.firebaseapp.com",
    databaseURL: "https://chaavaruthu-default-rtdb.firebaseio.com",
    projectId: "chaavaruthu",
    storageBucket: "chaavaruthu.firebasestorage.app",
    messagingSenderId: "21044301735",
    appId: "1:21044301735:web:c81aa40d29446dc37e7082"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let tasks = [];
  let capacityThreshold = 10;
  let volunteerId = document.getElementById('volIdInput').value;

  const colors = { energizing: "#E8874A", neutral: "#7FAF78", draining: "#5C7A9E" };

  function getMonday(d) {
    d = new Date(d);
    const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff)).toISOString().split('T')[0];
  }
  const currentWeekOf = getMonday(new Date());

  // Friendly week label
  const weekDisplay = new Date(currentWeekOf + 'T12:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
  document.getElementById('week-label').textContent = 'Week of ' + weekDisplay;

  // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    document.getElementById('greeting').textContent = `Hey ${volunteerId}`;

    db.ref(`volunteers/${volunteerId}/profile/capacityThreshold`).once('value', snap => {
      if (snap.exists()) {
        capacityThreshold = snap.val();
        document.getElementById('capacityInput').value = capacityThreshold;
      }
    });

    db.ref(`volunteers/${volunteerId}/autocomplete`).once('value', snap => {
      if (snap.exists()) {
        const list = document.getElementById('task-autocomplete');
        list.innerHTML = '';
        Object.keys(snap.val()).forEach(word => {
          const opt = document.createElement('option');
          opt.value = word;
          list.appendChild(opt);
        });
      }
    });

    const snap = await db.ref(`volunteers/${volunteerId}/weeks/${currentWeekOf}/tasks`).once('value');
    if (snap.exists()) {
      const data = snap.val();
      tasks = Array.isArray(data) ? data : Object.values(data);
      renderTasks();
    } else {
      if (tasks.length === 0) addTaskRow();
    }

    renderCalendarGallery();
  }

  // â”€â”€ TASK MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addTaskRow() {
    tasks.push({ id: Date.now().toString(), name: "", org: "", hours: 1, tag: null });
    renderTasks();
  }

  function removeTask(id) {
    tasks = tasks.filter(t => t.id !== id);
    renderTasks();
  }

  function updateTask(id, field, value) {
    const task = tasks.find(t => t.id === id);
    if (task) {
      task[field] = value;
      if (field === 'hours' || field === 'tag') renderPlate();
    }
  }

  window.changeHours = function(id, delta) {
    const task = tasks.find(t => t.id === id);
    if (task) {
      task.hours = Math.max(0.5, Math.min(24, task.hours + delta));
      renderTasks();
    }
  };

  window.setTag = function(id, tag) {
    updateTask(id, 'tag', tag);
    renderTasks();
  };

  function renderTasks() {
    const container = document.getElementById('task-list');
    container.innerHTML = '';

    tasks.forEach(task => {
      const row = document.createElement('div');
      row.className = 'task-row';
      row.innerHTML = `
        <div class="task-inputs">
          <input class="task-name-input" type="text" placeholder="What did you work on?" list="task-autocomplete"
            value="${task.name}" onchange="updateTask('${task.id}', 'name', this.value)">
          <input class="task-org-input" type="text" placeholder="Org or project"
            value="${task.org}" onchange="updateTask('${task.id}', 'org', this.value)">
        </div>
        <div class="hours-control">
          <button onclick="changeHours('${task.id}', -0.5)">âˆ’</button>
          <span class="hours-val">${task.hours}</span>
          <button onclick="changeHours('${task.id}', 0.5)">+</button>
        </div>
        <div class="tag-group">
          <button class="tag-btn ${task.tag === 'energizing' ? 'selected-energizing' : ''}" title="Energizing" onclick="setTag('${task.id}', 'energizing')">ğŸ”¥</button>
          <button class="tag-btn ${task.tag === 'neutral' ? 'selected-neutral' : ''}" title="Neutral" onclick="setTag('${task.id}', 'neutral')">ğŸ˜</button>
          <button class="tag-btn ${task.tag === 'draining' ? 'selected-draining' : ''}" title="Draining" onclick="setTag('${task.id}', 'draining')">ğŸª¨</button>
        </div>
        <button class="delete-btn" onclick="removeTask('${task.id}')">Ã—</button>
      `;
      container.appendChild(row);
    });

    renderPlate();
  }

  document.getElementById('btn-add-task').addEventListener('click', addTaskRow);

  document.getElementById('capacityInput').addEventListener('change', e => {
    capacityThreshold = parseFloat(e.target.value) || 10;
    db.ref(`volunteers/${volunteerId}/profile/capacityThreshold`).set(capacityThreshold);
    renderPlate();
  });

  document.getElementById('volIdInput').addEventListener('change', e => {
    volunteerId = e.target.value;
    tasks = [];
    init();
  });

  // â”€â”€ D3 PLATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function drawPlateSVG(containerId, size, taskData, cap) {
    const container = d3.select(`#${containerId}`);
    container.selectAll("*").remove();

    const eHrs = taskData.filter(t => t.tag === 'energizing').reduce((s, t) => s + t.hours, 0);
    const nHrs = taskData.filter(t => t.tag === 'neutral').reduce((s, t) => s + t.hours, 0);
    const dHrs = taskData.filter(t => t.tag === 'draining').reduce((s, t) => s + t.hours, 0);
    const total = eHrs + nHrs + dHrs;
    const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);

    const svg = container.append("svg")
      .attr("width", size).attr("height", size)
      .append("g").attr("transform", `translate(${size/2},${size/2})`);

    const rimRadius = size / 2 - (size > 100 ? 8 : 3);

    // Shadow under plate
    if (size > 100) {
      const defs = svg.append("defs");
      const filter = defs.append("filter").attr("id", "plate-shadow");
      filter.append("feDropShadow")
        .attr("dx", 0).attr("dy", 2)
        .attr("stdDeviation", 6)
        .attr("flood-color", "rgba(44,36,22,0.12)");
      svg.append("circle").attr("r", rimRadius + 2).attr("fill", "#EDE8DF").attr("filter", "url(#plate-shadow)");
    }

    // Plate background
    svg.append("circle").attr("r", rimRadius).attr("fill", "#F7F3EC");

    // Rim
    svg.append("circle")
      .attr("r", rimRadius)
      .attr("fill", "none")
      .attr("stroke", "#D4C9B5")
      .attr("stroke-width", size > 100 ? 8 : 3);

    if (total === 0) {
      svg.append("circle").attr("r", rimRadius - (size > 100 ? 10 : 3)).attr("fill", "#EDEAE3");
      if (size > 100) {
        svg.append("text")
          .attr("text-anchor", "middle").attr("dy", "5px")
          .attr("fill", "#B5A898").attr("font-size", "13px")
          .attr("font-family", "DM Sans, sans-serif")
          .text("Empty");
      }
      return;
    }

    const scale = weightedLoad > cap ? 1.08 : 1.0;
    const pie = d3.pie().value(d => d.value).sort(null).padAngle(0.03);
    const innerR = size > 100 ? rimRadius * 0.12 : 0;
    const arc = d3.arc()
      .innerRadius(innerR)
      .outerRadius((rimRadius - (size > 100 ? 10 : 3)) * scale)
      .cornerRadius(size > 100 ? 3 : 0);

    const drawData = [
      { label: "energizing", value: eHrs },
      { label: "neutral", value: nHrs },
      { label: "draining", value: dHrs }
    ];

    const arcs = svg.append("g").selectAll("path")
      .data(pie(drawData)).enter().append("path")
      .attr("fill", d => colors[d.data.label])
      .attr("d", arc)
      .attr("opacity", 0.92);

    if (size > 100 && containerId === "plate-viz") {
      arcs.style("cursor", "pointer")
        .on("mouseover", function() { d3.select(this).attr("opacity", 1); })
        .on("mouseout", function() { d3.select(this).attr("opacity", 0.92); })
        .on("click", (event, d) => showDetails(d.data.label, taskData));
    }
  }

  function renderPlate() {
    drawPlateSVG("plate-viz", 280, tasks, capacityThreshold);
  }

  function showDetails(tag, taskData) {
    const div = document.getElementById('arc-details');
    const filtered = taskData.filter(t => t.tag === tag);
    if (filtered.length === 0) { div.classList.add('hidden'); return; }
    const emoji = tag === 'energizing' ? 'ğŸ”¥' : tag === 'neutral' ? 'ğŸ˜' : 'ğŸª¨';
    let html = `<strong>${emoji} ${tag.charAt(0).toUpperCase() + tag.slice(1)}</strong> â€” `;
    html += filtered.map(t => `${t.name || 'Unnamed'} (${t.hours}h)`).join(', ');
    div.innerHTML = html;
    div.classList.remove('hidden');
  }

  // â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('btn-submit').addEventListener('click', async () => {
    const validTasks = tasks.filter(t => t.name.trim() !== "" && t.tag !== null);
    if (validTasks.length === 0) {
      alert("Add at least one task and give it a tag before saving.");
      return;
    }

    await db.ref(`volunteers/${volunteerId}/weeks/${currentWeekOf}/tasks`).set(validTasks);

    const autoUpdates = {};
    validTasks.forEach(t => {
      const sanitized = t.name.replace(/[.#$[\]\\]/g, "").trim();
      if (sanitized) autoUpdates[sanitized] = true;
    });
    await db.ref(`volunteers/${volunteerId}/autocomplete`).update(autoUpdates);

    showReflection(validTasks);
  });

  // â”€â”€ REFLECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function showReflection(submittedTasks) {
    document.getElementById('form-section').classList.add('hidden');
    document.getElementById('reflection-section').classList.remove('hidden');

    const eHrs = submittedTasks.filter(t => t.tag === 'energizing').reduce((s, t) => s + t.hours, 0);
    const nHrs = submittedTasks.filter(t => t.tag === 'neutral').reduce((s, t) => s + t.hours, 0);
    const dHrs = submittedTasks.filter(t => t.tag === 'draining').reduce((s, t) => s + t.hours, 0);
    const total = eHrs + nHrs + dHrs;
    const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);

    const ePct = Math.round((eHrs / total) * 100) || 0;
    const nPct = Math.round((nHrs / total) * 100) || 0;
    const dPct = Math.round((dHrs / total) * 100) || 0;

    document.getElementById('ref-raw-hours').textContent = `You gave ${total} hours this week.`;
    document.getElementById('ref-composition').textContent = `${dPct}% draining, ${nPct}% neutral, ${ePct}% energizing.`;

    let insight = "A mixed week. That's pretty normal.";
    if (weightedLoad > capacityThreshold) insight = "You went past your comfortable limit this week. Worth taking seriously.";
    else if (dPct > 60) insight = "That's a heavy week. Worth noticing.";
    else if (ePct > 60) insight = "Mostly work that gives back. A good week.";
    document.getElementById('ref-conditional').textContent = insight;

    setTimeout(() => drawPlateSVG("reflection-plate", 180, submittedTasks, capacityThreshold), 50);

    const d = new Date();
    d.setDate(d.getDate() - 7);
    const lastWeekOf = getMonday(d);
    const snap = await db.ref(`volunteers/${volunteerId}/weeks/${lastWeekOf}/tasks`).once('value');
    if (snap.exists()) {
      const lw = snap.val() ? (Array.isArray(snap.val()) ? snap.val() : Object.values(snap.val())) : [];
      const lE = lw.filter(t => t.tag === 'energizing').reduce((s, t) => s + t.hours, 0);
      const lN = lw.filter(t => t.tag === 'neutral').reduce((s, t) => s + t.hours, 0);
      const lD = lw.filter(t => t.tag === 'draining').reduce((s, t) => s + t.hours, 0);
      const lastLoad = (lD * 1.5) + (lN * 1.0) + (lE * 0.75);
      document.getElementById('ref-comparison').textContent =
        `Last week your weighted load was ${lastLoad.toFixed(1)}. This week it's ${weightedLoad.toFixed(1)}.`;
    } else {
      document.getElementById('ref-comparison').textContent = "No data from last week to compare.";
    }

    renderCalendarGallery();
  }

  // â”€â”€ GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function renderCalendarGallery() {
    const container = document.getElementById('calendar-grid');
    container.innerHTML = '';

    const snap = await db.ref(`volunteers/${volunteerId}/weeks`).once('value');
    const allWeeksData = snap.exists() ? snap.val() : {};

    for (let i = 0; i < 8; i++) {
      const d = new Date();
      const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff - (i * 7));

      const weekStr = d.toISOString().split('T')[0];
      const displayDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

      const cell = document.createElement('div');
      cell.className = 'calendar-cell';

      const svgId = `cal-plate-${weekStr}`;
      cell.innerHTML = `
        <div id="${svgId}" style="height:60px; display:flex; justify-content:center; align-items:center;"></div>
        <div class="calendar-date">${displayDate}</div>
      `;
      container.appendChild(cell);

      const weekTasksRaw = allWeeksData[weekStr] ? allWeeksData[weekStr].tasks : null;
      const weekTasks = weekTasksRaw
        ? (Array.isArray(weekTasksRaw) ? weekTasksRaw : Object.values(weekTasksRaw))
        : [];

      drawPlateSVG(svgId, 60, weekTasks, capacityThreshold);

      if (weekTasks.length > 0) {
        cell.classList.add('has-data');
        cell.onclick = () => openHistoryModal(displayDate, weekTasks);
      }
    }
  }

  function openHistoryModal(dateStr, tasksArr) {
    document.getElementById('modal-title').textContent = `Week of ${dateStr}`;

    const eHrs = tasksArr.filter(t => t.tag === 'energizing').reduce((s, t) => s + t.hours, 0);
    const nHrs = tasksArr.filter(t => t.tag === 'neutral').reduce((s, t) => s + t.hours, 0);
    const dHrs = tasksArr.filter(t => t.tag === 'draining').reduce((s, t) => s + t.hours, 0);
    const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);

    document.getElementById('modal-subtitle').textContent =
      `Weighted load: ${weightedLoad.toFixed(1)} / ${capacityThreshold}`;

    let listHtml = '';
    tasksArr.forEach(t => {
      const emoji = t.tag === 'energizing' ? 'ğŸ”¥' : t.tag === 'neutral' ? 'ğŸ˜' : 'ğŸª¨';
      listHtml += `
        <div class="modal-task-item">
          <span>${emoji} ${t.name}<span class="modal-task-org">${t.org ? '(' + t.org + ')' : ''}</span></span>
          <span class="modal-task-hrs">${t.hours}h</span>
        </div>`;
    });
    document.getElementById('modal-task-list').innerHTML = listHtml;

    document.getElementById('history-modal').classList.remove('hidden');
    setTimeout(() => drawPlateSVG('modal-plate', 160, tasksArr, capacityThreshold), 10);
  }

  // â”€â”€ DEMO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.generateDemoHistory = async function() {
    const dummy = [
      [{ id:'1', name:"Food bank sorting", org:"City Food Bank", hours:4, tag:"draining" }, { id:'2', name:"Volunteer emails", org:"", hours:2, tag:"neutral" }],
      [{ id:'3', name:"Mentoring session", org:"Local School", hours:3, tag:"energizing" }, { id:'4', name:"Event setup", org:"", hours:5, tag:"draining" }],
      [{ id:'5', name:"Social media", org:"Green Futures", hours:2, tag:"neutral" }, { id:'6', name:"Design work", org:"Green Futures", hours:4, tag:"energizing" }],
      [{ id:'7', name:"Inventory audit", org:"City Food Bank", hours:6, tag:"draining" }]
    ];
    for (let i = 1; i <= 4; i++) {
      const d = new Date();
      const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff - (i * 7));
      const pastWeek = d.toISOString().split('T')[0];
      await db.ref(`volunteers/${volunteerId}/weeks/${pastWeek}/tasks`).set(dummy[i - 1]);
    }
    renderCalendarGallery();
  };

  init();
</script>
</body>
</html>