<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Here's my week</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg-color: #FDFAF6;
      --card-border: #EEEBE6;
      --accent: #F4A261;
      --energizing: #F4A261;
      --neutral: #A8C5A0;
      --draining: #6B7FA3;
      --text-main: #333333;
      --text-muted: #777777;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      line-height: 1.7;
      padding: 40px 20px;
    }

    h1, h2, h3 { font-weight: 800; line-height: 1.2; margin-bottom: 16px; }
    h1 { font-size: 28px; }
    h2 { font-size: 22px; }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .card {
      background-color: #FFFFFF;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 24px;
    }

    input[type="text"], input[type="number"] {
      font-family: 'Inter', sans-serif;
      border: 1px solid #DDDDDD;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    input[type="text"]:focus, input[type="number"]:focus {
      border-color: var(--accent);
    }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    button {
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background-color: var(--accent);
      color: white;
      font-weight: 600;
      padding: 14px 24px;
      width: 100%;
      font-size: 16px;
    }
    .btn-primary:hover { opacity: 0.9; }

    .btn-secondary {
      background-color: transparent;
      color: var(--accent);
      font-weight: 600;
      padding: 10px 16px;
    }
    .btn-secondary:hover { background-color: #FFF5EC; }

    /* Task Row Styles */
    .task-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding-bottom: 16px;
      margin-bottom: 16px;
      border-bottom: 1px solid #F5F5F5;
    }
    .task-row input[type="text"] { flex: 1; min-width: 140px; }
    .task-row .hours-control { display: flex; align-items: center; gap: 8px; }
    .task-row .hours-control button { background: #F0F0F0; padding: 4px 12px; font-weight: bold; border-radius: 6px; }
    
    .tag-group { display: flex; gap: 6px; }
    .tag-btn { padding: 6px 10px; background: #F5F5F5; border: 1px solid transparent; font-size: 14px; color: transparent; text-shadow: 0 0 0 #555; }
    .tag-btn.selected-energizing { background-color: #FFF5EC; border-color: var(--energizing); }
    .tag-btn.selected-neutral { background-color: #F2F7F1; border-color: var(--neutral); }
    .tag-btn.selected-draining { background-color: #F0F2F6; border-color: var(--draining); }

    .delete-btn { background: none; color: #CCCCCC; font-size: 20px; padding: 4px; }
    .delete-btn:hover { color: #FF6B6B; }

    .plate-container { display: flex; justify-content: center; margin-bottom: 24px; position: relative; }
    .plate-details { text-align: center; margin-top: 16px; font-size: 14px; }

    /* Calendar Grid Styles */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
    }
    .calendar-cell {
      background: #FFFFFF;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 16px 8px;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .calendar-cell.has-data {
      cursor: pointer;
    }
    .calendar-cell.has-data:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border-color: var(--accent);
    }
    .calendar-date {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 12px;
      font-weight: 600;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; 
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-content {
      background: #FFFFFF; border-radius: 16px; padding: 32px; width: 100%; max-width: 420px; position: relative;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .close-btn {
      position: absolute; top: 16px; right: 20px; background: none; border: none; font-size: 28px; color: #999; cursor: pointer;
    }
    .close-btn:hover { color: var(--text-main); }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div class="container">
    <div style="margin-bottom: 24px; display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
      <span style="font-size: 12px; color: var(--text-muted);">Volunteer ID:</span>
      <input type="text" id="volIdInput" value="Priya" style="width: 100px; padding: 4px 8px;">
    </div>

    <div id="form-section">
      <h1 id="greeting">Hey Priya</h1>
      <p style="color: var(--text-muted); margin-bottom: 24px;">How's the week looking?</p>

      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="margin: 0; font-size: 16px;">My comfortable limit</h2>
          <div style="display: flex; align-items: center; gap: 8px;">
            <input type="number" id="capacityInput" value="10" style="width: 60px; text-align: center; font-weight: bold;">
            <span style="color: var(--text-muted); font-size: 14px;">hours</span>
          </div>
        </div>

        <div class="plate-container" id="plate-viz"></div>
        <div id="arc-details" class="plate-details hidden"></div>

        <h3 style="font-size: 16px; border-bottom: 1px solid var(--card-border); padding-bottom: 12px; margin-bottom: 16px;">What did you work on?</h3>
        
        <datalist id="task-autocomplete"></datalist>
        <div id="task-list"></div>

        <button id="btn-add-task" class="btn-secondary">+ What else is on your plate?</button>
      </div>

      <button id="btn-submit" class="btn-primary">Save my week</button>
    </div>

    <div id="reflection-section" class="card hidden" style="text-align: center; padding: 40px 24px;">
      <h2>How this week felt</h2>
      <div id="reflection-plate" style="display: flex; justify-content: center; margin: 24px 0;"></div>
      <p id="ref-raw-hours" style="font-weight: 600; font-size: 18px; margin-bottom: 8px;"></p>
      <p id="ref-composition" style="color: var(--text-muted); margin-bottom: 24px;"></p>
      
      <div style="background-color: #F9F9F9; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <p id="ref-conditional" style="font-weight: 600; margin-bottom: 8px;"></p>
        <p id="ref-comparison" style="font-size: 14px; color: var(--text-muted); margin: 0;"></p>
      </div>
      <button onclick="document.getElementById('history-section').scrollIntoView({behavior: 'smooth'})" class="btn-secondary">See my calendar</button>
    </div>

    <div id="history-section" style="margin-top: 48px;">
      <div style="border-bottom: 1px solid var(--card-border); padding-bottom: 8px; display: flex; justify-content: space-between; align-items: baseline;">
        <h3 style="font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin: 0;">Plate Portrait Gallery</h3>
      </div>
      <p style="font-size: 13px; color: var(--text-muted); margin-top: 8px;">A visual record of your capacity over the last 8 weeks. Click a plate to review.</p>
      
      <div id="calendar-grid" class="calendar-grid"></div>
    </div>

  </div>

  <div id="history-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <button class="close-btn" onclick="document.getElementById('history-modal').classList.add('hidden')">&times;</button>
      <h2 id="modal-title" style="font-size: 20px; margin-bottom: 4px;">Week of ...</h2>
      <p id="modal-subtitle" style="color: var(--text-muted); font-size: 14px; margin-bottom: 24px;">Weighted Load: 0 / 10</p>
      
      <div id="modal-plate" style="display: flex; justify-content: center; margin-bottom: 32px;"></div>
      
      <h3 style="font-size: 12px; text-transform: uppercase; color: #999; border-bottom: 1px solid #EEE; padding-bottom: 8px; margin-bottom: 12px;">Tasks Logged</h3>
      <div id="modal-task-list" style="font-size: 14px; max-height: 200px; overflow-y: auto; padding-right: 8px;"></div>
    </div>
  </div>

  <script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyCIuiidzKhTKrUDEIe34jeevCelWDttA3k",
      authDomain: "chaavaruthu.firebaseapp.com",
      databaseURL: "https://chaavaruthu-default-rtdb.firebaseio.com",
      projectId: "chaavaruthu",
      storageBucket: "chaavaruthu.firebasestorage.app",
      messagingSenderId: "21044301735",
      appId: "1:21044301735:web:c81aa40d29446dc37e7082"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- STATE ---
    let tasks = [];
    let capacityThreshold = 10;
    let volunteerId = document.getElementById('volIdInput').value;
    
    // Helpers
    function getMonday(d) {
      d = new Date(d);
      var day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6:1);
      return new Date(d.setDate(diff)).toISOString().split('T')[0];
    }
    const currentWeekOf = getMonday(new Date());

    const colors = { energizing: "#F4A261", neutral: "#A8C5A0", draining: "#6B7FA3" };

    // --- INITIALIZATION ---
    async function init() {
      document.getElementById('greeting').innerText = `Hey ${volunteerId}`;
      
      db.ref(`volunteers/${volunteerId}/profile/capacityThreshold`).once('value', snap => {
        if (snap.exists()) {
          capacityThreshold = snap.val();
          document.getElementById('capacityInput').value = capacityThreshold;
        }
      });

      db.ref(`volunteers/${volunteerId}/autocomplete`).once('value', snap => {
        if (snap.exists()) {
          const list = document.getElementById('task-autocomplete');
          list.innerHTML = '';
          Object.keys(snap.val()).forEach(word => {
            const opt = document.createElement('option');
            opt.value = word;
            list.appendChild(opt);
          });
        }
      });

      if(tasks.length === 0) addTaskRow();
      
      // Load the calendar right away
      renderCalendarGallery();
    }

    // --- TASK MANAGEMENT ---
    function addTaskRow() {
      tasks.push({ id: Date.now().toString(), name: "", org: "", hours: 1, tag: null });
      renderTasks();
    }

    function removeTask(id) {
      tasks = tasks.filter(t => t.id !== id);
      renderTasks();
    }

    function updateTask(id, field, value) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        task[field] = value;
        if(field === 'hours' || field === 'tag') renderPlate();
      }
    }

    function renderTasks() {
      const container = document.getElementById('task-list');
      container.innerHTML = '';

      tasks.forEach(task => {
        const row = document.createElement('div');
        row.className = 'task-row';

        row.innerHTML = `
          <input type="text" placeholder="What did you work on?" list="task-autocomplete" value="${task.name}" onchange="updateTask('${task.id}', 'name', this.value)">
          <input type="text" placeholder="Which org or project?" value="${task.org}" style="max-width: 140px;" onchange="updateTask('${task.id}', 'org', this.value)">
          
          <div class="hours-control">
            <button onclick="changeHours('${task.id}', -0.5)">-</button>
            <span style="width: 24px; text-align: center; font-size: 14px;">${task.hours}</span>
            <button onclick="changeHours('${task.id}', 0.5)">+</button>
          </div>

          <div class="tag-group">
            <button class="tag-btn ${task.tag === 'energizing' ? 'selected-energizing' : ''}" onclick="setTag('${task.id}', 'energizing'); renderTasks()">üî•</button>
            <button class="tag-btn ${task.tag === 'neutral' ? 'selected-neutral' : ''}" onclick="setTag('${task.id}', 'neutral'); renderTasks()">üòê</button>
            <button class="tag-btn ${task.tag === 'draining' ? 'selected-draining' : ''}" onclick="setTag('${task.id}', 'draining'); renderTasks()">ü™®</button>
          </div>
          
          <button class="delete-btn" onclick="removeTask('${task.id}')">√ó</button>
        `;
        container.appendChild(row);
      });
      renderPlate();
    }

    window.changeHours = function(id, delta) {
      const task = tasks.find(t => t.id === id);
      if (task) {
        task.hours = Math.max(0.5, Math.min(24, task.hours + delta));
        renderTasks();
      }
    };

    window.setTag = function(id, tag) {
      updateTask(id, 'tag', tag);
    };

    document.getElementById('btn-add-task').addEventListener('click', addTaskRow);
    
    document.getElementById('capacityInput').addEventListener('change', (e) => {
      capacityThreshold = parseFloat(e.target.value) || 10;
      db.ref(`volunteers/${volunteerId}/profile/capacityThreshold`).set(capacityThreshold);
      renderPlate();
    });

    document.getElementById('volIdInput').addEventListener('change', (e) => {
      volunteerId = e.target.value;
      tasks = [];
      init();
    });

    // --- D3 PLATE RENDERER ---
    function drawPlateSVG(containerId, size, taskData, cap) {
      const container = d3.select(`#${containerId}`);
      container.selectAll("*").remove();

      const eHrs = taskData.filter(t => t.tag === 'energizing').reduce((s,t) => s+t.hours, 0);
      const nHrs = taskData.filter(t => t.tag === 'neutral').reduce((s,t) => s+t.hours, 0);
      const dHrs = taskData.filter(t => t.tag === 'draining').reduce((s,t) => s+t.hours, 0);
      const total = eHrs + nHrs + dHrs;

      const svg = container.append("svg")
        .attr("width", size).attr("height", size)
        .append("g").attr("transform", `translate(${size/2},${size/2})`);

      const radius = size / 2;
      const rimRadius = radius - (size > 100 ? 10 : 4); // Scaled padding

      // Outer Rim
      svg.append("circle")
        .attr("r", rimRadius)
        .attr("fill", "none")
        .attr("stroke", "#E8E3DC")
        .attr("stroke-width", size > 100 ? 8 : 3);

      if (total === 0) {
        svg.append("circle").attr("r", rimRadius - (size > 100 ? 4 : 2)).attr("fill", "#F5F5F5");
        if (size > 100) {
          svg.append("text").attr("text-anchor", "middle").attr("dy", "5").attr("fill", "#AAAAAA").attr("font-size", "14px").text("Empty");
        }
        return;
      }

      const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);
      const scale = weightedLoad > cap ? 1.1 : 1.0; 

      const pie = d3.pie().value(d => d.value).sort(null);
      const arc = d3.arc().innerRadius(0).outerRadius((rimRadius - (size > 100 ? 4 : 2)) * scale);

      const drawData = [
        { label: "energizing", value: eHrs },
        { label: "neutral", value: nHrs },
        { label: "draining", value: dHrs }
      ];

      const arcs = svg.append("g").selectAll("path").data(pie(drawData)).enter().append("path")
        .attr("fill", d => colors[d.data.label])
        .attr("d", arc);

      if (size > 100 && containerId === "plate-viz") {
        arcs.style("cursor", "pointer")
            .on("click", (event, d) => showDetails(d.data.label, taskData));
      }
    }

    function renderPlate() {
      drawPlateSVG("plate-viz", 280, tasks, capacityThreshold);
    }

    function showDetails(tag, taskData) {
      const div = document.getElementById('arc-details');
      const filtered = taskData.filter(t => t.tag === tag);
      if (filtered.length === 0) return div.classList.add('hidden');

      const emoji = tag === 'energizing' ? 'üî•' : tag === 'neutral' ? 'üòê' : 'ü™®';
      let html = `<strong style="text-transform: capitalize;">${emoji} ${tag} Tasks</strong><br>`;
      filtered.forEach(t => html += `${t.name || 'Unnamed'} - ${t.hours}h<br>`);
      div.innerHTML = html;
      div.classList.remove('hidden');
    }

    // --- SUBMIT & REFLECTION ---
    document.getElementById('btn-submit').addEventListener('click', async () => {
      const validTasks = tasks.filter(t => t.name.trim() !== "" && t.tag !== null);
      if(validTasks.length === 0) return alert("Please add at least one complete task with a tag.");

      await db.ref(`volunteers/${volunteerId}/weeks/${currentWeekOf}/tasks`).set(validTasks);

      const autoUpdates = {};
      validTasks.forEach(t => {
        const sanitized = t.name.replace(/[.#$[\]\\]/g, "").trim();
        if(sanitized) autoUpdates[sanitized] = true;
      });
      await db.ref(`volunteers/${volunteerId}/autocomplete`).update(autoUpdates);

      showReflection(validTasks);
    });

    async function showReflection(submittedTasks) {
      document.getElementById('form-section').classList.add('hidden');
      document.getElementById('reflection-section').classList.remove('hidden');

      const eHrs = submittedTasks.filter(t => t.tag === 'energizing').reduce((s,t) => s+t.hours, 0);
      const nHrs = submittedTasks.filter(t => t.tag === 'neutral').reduce((s,t) => s+t.hours, 0);
      const dHrs = submittedTasks.filter(t => t.tag === 'draining').reduce((s,t) => s+t.hours, 0);
      const total = eHrs + nHrs + dHrs;
      const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);

      document.getElementById('ref-raw-hours').innerText = `You gave ${total} hours this week.`;
      
      const ePct = Math.round((eHrs/total)*100);
      const nPct = Math.round((nHrs/total)*100);
      const dPct = Math.round((dHrs/total)*100);
      document.getElementById('ref-composition').innerText = `${dPct}% of that felt draining, ${nPct}% neutral, ${ePct}% energizing.`;

      let condText = "A mixed week. That's pretty normal.";
      if (weightedLoad > capacityThreshold) condText = "You went beyond your comfortable limit this week. Take that seriously.";
      else if (dPct > 60) condText = "That's a heavy week. Worth noticing.";
      else if (ePct > 60) condText = "A good week ‚Äî mostly work that gives back.";
      document.getElementById('ref-conditional').innerText = condText;

      drawPlateSVG("reflection-plate", 160, submittedTasks, capacityThreshold);

      // Fetch last week
      const d = new Date();
      d.setDate(d.getDate() - 7);
      const lastWeekOf = getMonday(d);
      
      const snap = await db.ref(`volunteers/${volunteerId}/weeks/${lastWeekOf}/tasks`).once('value');
      if (snap.exists()) {
        const lwTasks = snap.val() || [];
        const lE = lwTasks.filter(t => t.tag === 'energizing').reduce((s,t) => s+t.hours, 0);
        const lN = lwTasks.filter(t => t.tag === 'neutral').reduce((s,t) => s+t.hours, 0);
        const lD = lwTasks.filter(t => t.tag === 'draining').reduce((s,t) => s+t.hours, 0);
        const lastLoad = (lD * 1.5) + (lN * 1.0) + (lE * 0.75);
        document.getElementById('ref-comparison').innerText = `Last week your weighted load was ${lastLoad.toFixed(1)}. This week it's ${weightedLoad.toFixed(1)}.`;
      } else {
        document.getElementById('ref-comparison').innerText = "No data from last week to compare.";
      }
      
      renderCalendarGallery(); // Refresh calendar to include new submission
    }

    // --- CALENDAR GALLERY LOGIC ---
    async function renderCalendarGallery() {
      const container = document.getElementById('calendar-grid');
      container.innerHTML = '';

      // Fetch all past weeks for this volunteer in one call
      const snap = await db.ref(`volunteers/${volunteerId}/weeks`).once('value');
      const allWeeksData = snap.exists() ? snap.val() : {};

      // Build the grid for the last 8 weeks
      for (let i = 0; i < 8; i++) {
        const d = new Date();
        const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6:1);
        d.setDate(diff - (i * 7)); // Walk backwards week by week
        
        const weekStr = d.toISOString().split('T')[0];
        const displayDate = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        
        // Ensure unique ID for D3 container
        const svgContainerId = `cal-plate-${weekStr}`;
        cell.innerHTML = `
          <div id="${svgContainerId}" style="height: 60px; display: flex; justify-content: center; align-items: center;"></div>
          <div class="calendar-date">${displayDate}</div>
        `;
        container.appendChild(cell);

        const weekTasksObj = allWeeksData[weekStr] ? allWeeksData[weekStr].tasks : null;
        // Firebase might store arrays as objects with indices if keys are missing, ensure it's an array
        const weekTasks = weekTasksObj ? (Array.isArray(weekTasksObj) ? weekTasksObj : Object.values(weekTasksObj)) : [];

        drawPlateSVG(svgContainerId, 60, weekTasks, capacityThreshold);

        if (weekTasks.length > 0) {
          cell.classList.add('has-data');
          cell.title = "Click to view details";
          cell.onclick = () => openHistoryModal(displayDate, weekTasks);
        } else {
          cell.title = "No tasks logged this week";
        }
      }
    }

    function openHistoryModal(dateStr, tasksArr) {
      document.getElementById('modal-title').innerText = `Week of ${dateStr}`;
      
      // Calculate math for modal subtitle
      const eHrs = tasksArr.filter(t => t.tag === 'energizing').reduce((s,t) => s+t.hours, 0);
      const nHrs = tasksArr.filter(t => t.tag === 'neutral').reduce((s,t) => s+t.hours, 0);
      const dHrs = tasksArr.filter(t => t.tag === 'draining').reduce((s,t) => s+t.hours, 0);
      const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);
      
      document.getElementById('modal-subtitle').innerText = `Weighted Load: ${weightedLoad.toFixed(1)} / ${capacityThreshold}`;

      // Build task list HTML
      let listHtml = '';
      tasksArr.forEach(t => {
        const emoji = t.tag === 'energizing' ? 'üî•' : t.tag === 'neutral' ? 'üòê' : 'ü™®';
        listHtml += `
          <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #F5F5F5; margin-bottom: 4px;">
            <span>${emoji} ${t.name} <span style="color: #999; font-size: 12px;">(${t.org || 'None'})</span></span>
            <span style="font-weight: bold; color: var(--text-main);">${t.hours}h</span>
          </div>`;
      });
      document.getElementById('modal-task-list').innerHTML = listHtml;

      // Show Modal
      document.getElementById('history-modal').classList.remove('hidden');

      // Draw large plate in modal
      setTimeout(() => drawPlateSVG('modal-plate', 160, tasksArr, capacityThreshold), 10);
    }

    init();
  </script>
</body>
</html>