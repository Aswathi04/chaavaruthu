<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>What's On My Plate?</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen bg-gray-50 p-6 font-sans">

  <div class="max-w-md mx-auto bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-100 p-8" id="mainCard">
    <h1 class="text-2xl font-bold text-gray-800 mb-2">What's on your plate?</h1>
    <p class="text-sm text-gray-500 mb-6">See what's filling your week before you say yes to anything else.</p>

    <div class="flex justify-center mb-8 relative">
      <div class="absolute inset-0 rounded-full border-4 border-gray-100" style="width: 200px; height: 200px; left: 50%; transform: translateX(-50%);"></div>
      <div id="plate-viz"></div>
    </div>

    <div class="space-y-4 mb-8">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Your Name</label>
        <input type="text" id="volName" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Priya">
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Total Comfortable Capacity (Hours)</label>
        <input type="number" id="baseCap" value="10" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500">
      </div>
      
      <p class="text-sm font-semibold text-gray-700 pt-4 border-t">Tag your hours this week:</p>
      
      <div class="flex items-center justify-between p-3 bg-orange-50 rounded-xl">
        <span class="flex items-center gap-2 font-medium"><span class="w-3 h-3 rounded-full bg-[#F4A261]"></span> üî• Energizing</span>
        <input type="number" id="eHrs" value="0" min="0" class="w-20 p-2 text-center rounded-lg border-none">
      </div>
      <div class="flex items-center justify-between p-3 bg-green-50 rounded-xl">
        <span class="flex items-center gap-2 font-medium"><span class="w-3 h-3 rounded-full bg-[#A8C5A0]"></span> üòê Neutral</span>
        <input type="number" id="nHrs" value="0" min="0" class="w-20 p-2 text-center rounded-lg border-none">
      </div>
      <div class="flex items-center justify-between p-3 bg-slate-100 rounded-xl">
        <span class="flex items-center gap-2 font-medium"><span class="w-3 h-3 rounded-full bg-[#6B7FA3]"></span> ü™® Draining</span>
        <input type="number" id="dHrs" value="0" min="0" class="w-20 p-2 text-center rounded-lg border-none">
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-gray-700 mt-4 mb-1">Notes (Optional)</label>
        <input type="text" id="volNote" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Covering for Jake again">
      </div>
    </div>

    <button onclick="submitPlate()" class="w-full py-4 bg-blue-900 text-white font-bold rounded-2xl shadow-md hover:bg-blue-800 transition-all text-lg">
      Lock in my plate
    </button>
  </div>

  <div class="max-w-md mx-auto bg-white rounded-3xl shadow-lg overflow-hidden border border-gray-100 p-8 hidden" id="receiptCard">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Capacity Receipt</h2>
    <p id="receiptText" class="text-lg text-gray-600 mb-6 leading-relaxed"></p>
    <div class="p-4 bg-gray-50 rounded-xl italic text-gray-500 text-sm mb-6">
      "This week: full-bodied and heavy, with strong notes of administration..."
    </div>
    <button onclick="location.reload()" class="w-full py-3 border-2 border-blue-900 text-blue-900 font-bold rounded-xl hover:bg-gray-50 transition-all">
      Start Over
    </button>
  </div>

  <script>
    // 1. YOUR FIREBASE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyCIuiidzKhTKrUDEIe34jeevCelWDttA3k",
      authDomain: "chaavaruthu.firebaseapp.com",
      databaseURL: "https://chaavaruthu-default-rtdb.firebaseio.com",
      projectId: "chaavaruthu",
      storageBucket: "chaavaruthu.firebasestorage.app",
      messagingSenderId: "21044301735",
      appId: "1:21044301735:web:c81aa40d29446dc37e7082",
      measurementId: "G-18BY8VY06N"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. D3.js Plate Visualization
    const width = 200, height = 200, radius = Math.min(width, height) / 2;
    const svg = d3.select("#plate-viz").append("svg")
      .attr("width", width).attr("height", height)
      .append("g").attr("transform", `translate(${width/2},${height/2})`);

    const color = d3.scaleOrdinal()
      .domain(["Energizing", "Neutral", "Draining"])
      .range(["#F4A261", "#A8C5A0", "#6B7FA3"]); // Core emotional colors

    const pie = d3.pie().value(d => d.value).sort(null);
    const arc = d3.arc().innerRadius(0).outerRadius(radius - 10);

    function updatePlate() {
      const e = parseFloat(document.getElementById('eHrs').value) || 0;
      const n = parseFloat(document.getElementById('nHrs').value) || 0;
      const d = parseFloat(document.getElementById('dHrs').value) || 0;
      
      const data = [
        {label: "Energizing", value: e},
        {label: "Neutral", value: n},
        {label: "Draining", value: d}
      ];

      const drawData = (e+n+d === 0) ? [{label: "Empty", value: 1}] : data;
      const arcData = pie(drawData);

      svg.selectAll("path").data(arcData)
        .join("path")
        .attr("d", arc)
        .attr("fill", d => d.data.label === "Empty" ? "#f3f4f6" : color(d.data.label))
        .transition().duration(500);
    }

    ['eHrs', 'nHrs', 'dHrs'].forEach(id => {
      document.getElementById(id).addEventListener('input', updatePlate);
    });
    updatePlate();

    // 3. Submit Logic
    function submitPlate() {
      const name = document.getElementById('volName').value || "Anonymous";
      const baseCap = parseFloat(document.getElementById('baseCap').value) || 10;
      const eHrs = parseFloat(document.getElementById('eHrs').value) || 0;
      const nHrs = parseFloat(document.getElementById('nHrs').value) || 0;
      const dHrs = parseFloat(document.getElementById('dHrs').value) || 0;
      const note = document.getElementById('volNote').value;

      // Calculate weighted load for the receipt
      const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);
      const remaining = (baseCap - weightedLoad).toFixed(1);

      db.ref('checkins/' + name).set({
        name: name,
        base_capacity: baseCap,
        energizing_hrs: eHrs,
        neutral_hrs: nHrs,
        draining_hrs: dHrs,
        note: note,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        // Show Capacity Receipt
        document.getElementById('mainCard').classList.add('hidden');
        document.getElementById('receiptCard').classList.remove('hidden');
        
        let receiptHtml = `Your plate carries a weighted load of <strong>${weightedLoad.toFixed(1)} / ${baseCap}</strong>. <br><br>`;
        if (remaining > 0) {
          receiptHtml += `You have roughly <strong>${remaining} hours</strong> of comfortable capacity left.`;
        } else {
          receiptHtml += `Your plate is <strong>overflowing</strong>. It's time to redistribute tasks.`;
        }
        document.getElementById('receiptText').innerHTML = receiptHtml;
      });
    }
  </script>
</body>
</html>