<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VolunteerFlow â€” Capacity Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen bg-gray-100">

  <div class="bg-blue-900 text-white px-8 py-5 flex justify-between items-center shadow-lg">
    <div>
      <h1 class="text-2xl font-bold tracking-tight">VolunteerFlow</h1>
      <p class="text-blue-300 text-sm mt-0.5">Coordinator Capacity Dashboard â€” Live</p>
    </div>
    <div class="text-right">
      <p id="statTotal" class="font-semibold text-lg">Loading...</p>
      <p id="statRisk"  class="text-sm text-red-300"></p>
    </div>
  </div>

  <div id="flagSection" class="hidden bg-red-50 border-b-2 border-red-200 px-8 py-4">
    <p class="font-bold text-red-700 mb-3">âš ï¸ Over capacity - Redistribute to protect capacity</p>
    <div id="flagList" class="flex flex-wrap gap-2"></div>
  </div>

  <div class="px-8 pt-6 pb-2 flex gap-3">
    <button onclick="filterCards('all')" class="px-4 py-2 rounded-full bg-blue-800 text-white text-sm font-semibold hover:bg-blue-900">All Plates</button>
    <button onclick="filterCards('red')" class="px-4 py-2 rounded-full bg-red-100 text-red-700 text-sm font-semibold hover:bg-red-200">ğŸ”´ Overloaded</button>
    <button onclick="filterCards('yellow')" class="px-4 py-2 rounded-full bg-yellow-100 text-yellow-700 text-sm font-semibold hover:bg-yellow-200">ğŸŸ¡ Nearing Capacity</button>
    <button onclick="filterCards('green')" class="px-4 py-2 rounded-full bg-green-100 text-green-700 text-sm font-semibold hover:bg-green-200">ğŸŸ¢ Balanced</button>
    <a href="checkin.html" class="ml-auto px-4 py-2 rounded-full border border-blue-300 text-blue-700 text-sm hover:bg-blue-50">
      â†’ View Volunteer Plate
    </a>
  </div>

  <div id="cardGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 px-8 py-4">
    <div id="loadingMsg" class="col-span-3 text-center mt-16 text-gray-400">Loading capacity data...</div>
  </div>

  <script>
    // 1. YOUR FIREBASE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyCIuiidzKhTKrUDEIe34jeevCelWDttA3k",
      authDomain: "chaavaruthu.firebaseapp.com",
      databaseURL: "https://chaavaruthu-default-rtdb.firebaseio.com",
      projectId: "chaavaruthu",
      storageBucket: "chaavaruthu.firebasestorage.app",
      messagingSenderId: "21044301735",
      appId: "1:21044301735:web:c81aa40d29446dc37e7082",
      measurementId: "G-18BY8VY06N"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    var allVolunteers = [];

    // 2. MAIN LOGIC LISTENER
    db.ref('checkins').on('value', function(snapshot) {
      document.getElementById('loadingMsg').style.display = 'none';
      var data = snapshot.val();
      
      document.getElementById('cardGrid').innerHTML = '<div id="emptyMsg" class="col-span-3 text-center text-gray-400 mt-16 text-lg">No plates submitted yet.</div>';
      document.getElementById('flagList').innerHTML = '';

      if (!data) return;
      document.getElementById('emptyMsg').style.display = 'none';

      allVolunteers = Object.entries(data).map(function(entry) {
        var v = Object.assign({ key: entry[0] }, entry[1]);
        
        // Weighted Capacity Formula 
        var eHrs = parseFloat(v.energizing_hrs) || 0;
        var nHrs = parseFloat(v.neutral_hrs) || 0;
        var dHrs = parseFloat(v.draining_hrs) || 0;
        var capacity = parseFloat(v.base_capacity) || 10; 
        
        v.weighted_load = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);
        v.load_ratio = v.weighted_load / capacity;

        // Overflow State logic [cite: 494, 495]
        if (v.load_ratio >= 1.0) { v.status = 'red'; }
        else if (v.load_ratio >= 0.75) { v.status = 'yellow'; }
        else { v.status = 'green'; }

        return v;
      });

      allVolunteers.sort((a, b) => b.load_ratio - a.load_ratio);

      var atRisk = allVolunteers.filter(v => v.status === 'red' || v.status === 'yellow').length;
      document.getElementById('statTotal').textContent = allVolunteers.length + ' volunteer(s)';
      document.getElementById('statRisk').textContent = atRisk > 0 ? atRisk + ' plates near overflow âš ï¸' : 'All plates balanced âœ“';

      if (atRisk > 0) {
        document.getElementById('flagSection').classList.remove('hidden');
        allVolunteers.filter(v => v.status === 'red' || v.status === 'yellow').forEach(v => {
            document.getElementById('flagList').appendChild(makeFlagBadge(v));
        });
      } else {
        document.getElementById('flagSection').classList.add('hidden');
      }

      renderCards(allVolunteers);
    });

    function renderCards(list) {
      var grid = document.getElementById('cardGrid');
      grid.innerHTML = '';
      list.forEach(v => grid.appendChild(makeCard(v)));
    }

    function filterCards(status) {
      var filtered = status === 'all' ? allVolunteers : allVolunteers.filter(v => v.status === status);
      renderCards(filtered);
    }

    // 3. GENERATE CARDS & MINI-PLATES 
    function makeCard(v) {
      var cfg = {
        green:  { bg: 'bg-green-50', border: 'border-green-400', badge: 'bg-green-100 text-green-800', label: 'ğŸŸ¢ Balanced' },
        yellow: { bg: 'bg-yellow-50', border: 'border-yellow-400', badge: 'bg-yellow-100 text-yellow-800', label: 'ğŸŸ¡ Nearing Capacity' },
        red:    { bg: 'bg-red-50', border: 'border-red-500', badge: 'bg-red-100 text-red-800', label: 'ğŸ”´ Overloaded' }
      };
      var c = cfg[v.status] || cfg.green;

      var eHrs = parseFloat(v.energizing_hrs) || 0;
      var nHrs = parseFloat(v.neutral_hrs) || 0;
      var dHrs = parseFloat(v.draining_hrs) || 0;
      var total = eHrs + nHrs + dHrs;
      
      var ePct = total > 0 ? (eHrs / total) * 100 : 0;
      var nPct = total > 0 ? (nHrs / total) * 100 : 0;
      var dPct = total > 0 ? (dHrs / total) * 100 : 0;

      // Dynamic CSS Conic Gradient using exact emotional colors [cite: 483-487]
      var gradient = `conic-gradient(
        #F4A261 0% ${ePct}%, 
        #A8C5A0 ${ePct}% ${ePct + nPct}%, 
        #6B7FA3 ${ePct + nPct}% 100%
      )`;

      var card = document.createElement('div');
      card.className = 'rounded-2xl border-2 p-6 shadow-sm transition-all ' + c.bg + ' ' + c.border + (v.status === 'red' ? ' shadow-red-200 shadow-lg ring-2 ring-red-400' : '');

      card.innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 class="font-bold text-xl text-gray-800">${v.name || v.key}</h3>
            <span class="inline-block px-2 py-1 mt-2 rounded text-xs font-semibold ${c.badge}">${c.label}</span>
          </div>
          <div class="w-16 h-16 rounded-full shadow-inner border-2 border-gray-200" style="background: ${gradient};"></div>
        </div>

        <div class="text-3xl font-black text-gray-800 my-2 leading-none">${v.weighted_load.toFixed(1)} <span class="text-lg text-gray-400 font-normal">/ ${v.base_capacity} hrs</span></div>
        <p class="text-gray-500 text-xs mb-4 font-semibold uppercase tracking-wide">Energy Budget</p>

        <div class="mt-4 space-y-2 text-sm text-gray-600 border-t pt-4">
          <div class="flex justify-between items-center">
            <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#F4A261]"></span> ğŸ”¥ Energizing</span>
            <span class="font-semibold">${eHrs} hrs</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#A8C5A0]"></span> ğŸ˜ Neutral</span>
            <span class="font-semibold">${nHrs} hrs</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#6B7FA3]"></span> ğŸª¨ Draining</span>
            <span class="font-semibold">${dHrs} hrs</span>
          </div>
        </div>
      `;
      return card;
    }

    function makeFlagBadge(v) {
      var pill = document.createElement('div');
      var isRed = v.status === 'red';
      pill.className = 'px-4 py-1.5 rounded-full text-sm font-bold cursor-pointer ' + (isRed ? 'bg-red-200 text-red-800' : 'bg-yellow-200 text-yellow-800');
      pill.textContent = (isRed ? 'ğŸ”´ ' : 'ğŸŸ¡ ') + (v.name || v.key) + ' (Load: ' + v.weighted_load.toFixed(1) + ')';
      return pill;
    }
  </script>
</body>
</html>