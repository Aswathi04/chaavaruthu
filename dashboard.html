<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coordinator Capacity Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body class="min-h-screen bg-gray-100">

  <div class="bg-blue-900 text-white px-8 py-5 flex justify-between items-center shadow-lg">
    <div>
      <h1 class="text-2xl font-bold tracking-tight">VolunteerFlow</h1>
      <p class="text-blue-300 text-sm mt-0.5">Coordinator Capacity Dashboard</p>
    </div>
    <div class="text-right">
      <p id="statTotal" class="font-semibold text-lg">Loading...</p>
    </div>
  </div>

  <div class="px-8 pt-6 pb-2 flex gap-3">
    <button onclick="filterCards('all')" class="px-4 py-2 rounded-full bg-blue-800 text-white text-sm font-semibold hover:bg-blue-900">All</button>
    <button onclick="filterCards('red')" class="px-4 py-2 rounded-full bg-red-100 text-red-700 text-sm font-semibold hover:bg-red-200">üî¥ Overflow (> 1.0)</button>
    <button onclick="filterCards('yellow')" class="px-4 py-2 rounded-full bg-yellow-100 text-yellow-700 text-sm font-semibold hover:bg-yellow-200">üü° Near Cap (> 0.85)</button>
    <button onclick="filterCards('green')" class="px-4 py-2 rounded-full bg-green-100 text-green-700 text-sm font-semibold hover:bg-green-200">üü¢ Balanced</button>
    <a href="checkin.html" class="ml-auto px-4 py-2 rounded-full border border-blue-300 text-blue-700 text-sm hover:bg-blue-50">
      ‚Üí View Input Form
    </a>
  </div>

  <div id="cardGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 px-8 py-4">
    <div id="loadingMsg" class="col-span-full text-center mt-16 text-gray-400">Loading live data...</div>
  </div>

  <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden relative flex flex-col max-h-full">
      <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl font-bold">&times;</button>
      <div id="modal-content" class="p-8 overflow-y-auto"></div>
    </div>
  </div>

  <script>
    // --- 1. FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyCIuiidzKhTKrUDEIe34jeevCelWDttA3k",
      authDomain: "chaavaruthu.firebaseapp.com",
      databaseURL: "https://chaavaruthu-default-rtdb.firebaseio.com",
      projectId: "chaavaruthu",
      storageBucket: "chaavaruthu.firebasestorage.app",
      messagingSenderId: "21044301735",
      appId: "1:21044301735:web:c81aa40d29446dc37e7082"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allVolunteers = [];

    // Color Scale for Mini-Plates
    const colorScale = d3.scaleOrdinal()
      .domain(["energizing", "neutral", "draining"])
      .range(["#F4A261", "#A8C5A0", "#6B7FA3"]);
    const pie = d3.pie().value(d => d.value).sort(null);

    // --- 2. DATA LISTENER ---
    db.ref('volunteers').on('value', snap => {
      document.getElementById('loadingMsg').style.display = 'none';
      const data = snap.val();
      
      if(!data) {
        document.getElementById('cardGrid').innerHTML = '<div class="col-span-full text-center text-gray-400 mt-16">No volunteer data found.</div>';
        return;
      }

      allVolunteers = [];

      Object.keys(data).forEach(vid => {
        const vol = data[vid];
        const capacity = (vol.profile && vol.profile.capacityThreshold) ? parseFloat(vol.profile.capacityThreshold) : 10;
        
        let latestTasks = [];
        let weekLabel = "No data";
        
        if (vol.weeks) {
          const weeksList = Object.keys(vol.weeks).sort();
          if (weeksList.length > 0) {
            weekLabel = weeksList[weeksList.length - 1]; // newest
            const tasksObj = vol.weeks[weekLabel].tasks;
            if (tasksObj) latestTasks = Object.values(tasksObj);
          }
        }

        const eHrs = latestTasks.filter(t => t.tag === 'energizing').reduce((s,t) => s+t.hours, 0);
        const nHrs = latestTasks.filter(t => t.tag === 'neutral').reduce((s,t) => s+t.hours, 0);
        const dHrs = latestTasks.filter(t => t.tag === 'draining').reduce((s,t) => s+t.hours, 0);
        
        const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);
        const ratio = capacity > 0 ? weightedLoad / capacity : 0;
        
        // Flag logic override
        let status = 'green';
        if (ratio >= 1.0) status = 'red';
        else if (ratio > 0.85) status = 'yellow';

        allVolunteers.push({
          id: vid,
          capacity, latestTasks, eHrs, nHrs, dHrs, weightedLoad, ratio, status, weekLabel
        });
      });

      // Sort by highest ratio
      allVolunteers.sort((a, b) => b.ratio - a.ratio);
      
      document.getElementById('statTotal').textContent = `${allVolunteers.length} Active Volunteers`;
      renderCards(allVolunteers);
    });

    // --- 3. RENDERING ---
    function renderCards(list) {
      const grid = document.getElementById('cardGrid');
      grid.innerHTML = '';
      
      list.forEach(v => {
        const cfg = {
          green:  { bg: 'bg-green-50', border: 'border-green-200' },
          yellow: { bg: 'bg-yellow-50', border: 'border-yellow-400' },
          red:    { bg: 'bg-red-50', border: 'border-red-500 shadow-red-200 shadow-lg ring-2 ring-red-400' }
        };
        const c = cfg[v.status] || cfg.green;

        const card = document.createElement('div');
        card.className = `rounded-2xl border-2 p-5 transition-all cursor-pointer hover:-translate-y-1 bg-white ${c.border}`;
        card.onclick = () => openModal(v.id);

        card.innerHTML = `
          <div class="flex justify-between items-start mb-4">
            <div>
              <h3 class="font-bold text-lg text-gray-800">${v.id}</h3>
              <p class="text-xs text-gray-400 mt-1">Week: ${v.weekLabel}</p>
            </div>
            <div id="mini-svg-${v.id}" class="w-[60px] h-[60px] flex-shrink-0"></div>
          </div>
          
          <div class="flex items-end gap-2 mt-4">
            <div class="text-3xl font-black text-gray-800 leading-none">${v.weightedLoad.toFixed(1)}</div>
            <div class="text-sm text-gray-400 mb-1">/ ${v.capacity} hrs</div>
          </div>
          
          <div class="w-full bg-gray-200 rounded-full h-1.5 mt-3 overflow-hidden">
            <div class="${v.status === 'red' ? 'bg-red-500' : v.status === 'yellow' ? 'bg-yellow-500' : 'bg-green-500'} h-1.5 rounded-full" style="width: ${Math.min(100, v.ratio * 100)}%"></div>
          </div>
        `;
        grid.appendChild(card);

        // Render D3 Mini Plate inside the card
        drawMiniPlate(v, `#mini-svg-${v.id}`, 60);
      });
    }

    function drawMiniPlate(v, selector, size) {
      const radius = size / 2;
      const baseRadius = radius - 4; // leave room for stroke

      const svg = d3.select(selector).append("svg")
        .attr("width", size).attr("height", size)
        .append("g").attr("transform", `translate(${size/2},${size/2})`);

      // Outer Rim
      svg.append("circle").attr("r", baseRadius).attr("fill", "none").attr("stroke", "#e5e7eb").attr("stroke-width", 2);

      let scale = 1;
      if (v.capacity > 0 && v.weightedLoad > v.capacity) {
        scale = Math.min(1.15, v.weightedLoad / v.capacity);
      }
      
      const arcGenerator = d3.arc().innerRadius(0).outerRadius(baseRadius * scale);
      
      const drawData = (v.eHrs+v.nHrs+v.dHrs === 0) 
        ? [{ label: "empty", value: 1 }] 
        : [{ label: "energizing", value: v.eHrs }, { label: "neutral", value: v.nHrs }, { label: "draining", value: v.dHrs }];

      svg.selectAll(".slice").data(pie(drawData))
        .enter().append("path")
        .attr("class", "slice")
        .attr("fill", d => d.data.label === "empty" ? "transparent" : colorScale(d.data.label))
        .attr("d", arcGenerator);
    }

    function filterCards(status) {
      const filtered = status === 'all' ? allVolunteers : allVolunteers.filter(v => v.status === status);
      renderCards(filtered);
    }

    // --- 4. MODAL LOGIC ---
    function openModal(vid) {
      const v = allVolunteers.find(x => x.id === vid);
      if(!v) return;

      const modal = document.getElementById('modal-overlay');
      const content = document.getElementById('modal-content');
      
      let html = `
        <h2 class="text-3xl font-bold text-gray-800 mb-1">${v.id}</h2>
        <p class="text-sm text-gray-500 mb-6">Week of ${v.weekLabel} ‚Ä¢ ${v.capacity} hrs capacity</p>
        
        <div class="flex justify-center mb-6">
          <div id="modal-svg-container" class="w-[180px] h-[180px]"></div>
        </div>

        <div class="bg-gray-50 rounded-xl p-4 mb-6 text-center shadow-sm border border-gray-100">
          <p class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Weighted Load</p>
          <div class="text-4xl font-black ${v.status === 'red' ? 'text-red-600' : 'text-blue-900'}">${v.weightedLoad.toFixed(1)} <span class="text-xl text-gray-400 font-normal">/ ${v.capacity}</span></div>
        </div>
      `;

      if (v.latestTasks.length === 0) {
        html += `<p class="text-center text-gray-400 italic">No tasks logged.</p>`;
      } else {
        html += `<div class="space-y-2">`;
        v.latestTasks.forEach(t => {
          const emoji = t.tag === 'energizing' ? 'üî•' : t.tag === 'neutral' ? 'üòê' : 'ü™®';
          html += `
            <div class="flex justify-between items-center p-3 border-b border-gray-100 last:border-0">
              <div>
                <span class="font-semibold text-gray-800">${t.name}</span>
                <span class="text-xs text-gray-400 ml-1">(${t.org})</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-lg">${emoji}</span>
                <span class="font-bold w-8 text-right">${t.hours}h</span>
              </div>
            </div>
          `;
        });
        html += `</div>`;
      }

      content.innerHTML = html;
      modal.classList.remove('hidden');

      // Draw large plate in modal
      setTimeout(() => drawMiniPlate(v, '#modal-svg-container', 180), 10);
    }

    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
    }
  </script>
</body>
</html>