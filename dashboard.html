<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VolunteerFlow â€” Your team this week</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg:        #F5F0E8;
      --surface:   #FDFAF5;
      --border:    #E2D9C8;
      --ink:       #2C2416;
      --ink-soft:  #7A6E5F;
      --ink-faint: #B5A898;
      --energizing:#E8874A;
      --neutral:   #7FAF78;
      --draining:  #5C7A9E;
      --accent:    #E8874A;
      --green:     #4A9B5F;
      --yellow:    #D4A017;
      --red:       #B84040;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'DM Sans', sans-serif;
      background-color: var(--bg);
      color: var(--ink);
      line-height: 1.7;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed; inset: 0;
      background:
        radial-gradient(ellipse at 15% 15%, rgba(232,135,74,0.05) 0%, transparent 55%),
        radial-gradient(ellipse at 85% 85%, rgba(92,122,158,0.05) 0%, transparent 55%);
      pointer-events: none; z-index: 0;
    }

    .page {
      position: relative; z-index: 1;
      max-width: 1040px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 48px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .logo {
      font-family: 'Lora', serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--ink);
      letter-spacing: -0.3px;
    }
    .logo span { color: var(--accent); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    #loading-text {
      font-size: 12px;
      color: var(--ink-faint);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .live-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* â”€â”€ PAGE TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-title {
      margin-bottom: 36px;
    }
    .page-title h1 {
      font-family: 'Lora', serif;
      font-size: 34px;
      font-weight: 600;
      letter-spacing: -0.5px;
      margin-bottom: 4px;
    }
    .page-title p {
      font-size: 15px;
      color: var(--ink-soft);
      font-style: italic;
      font-family: 'Lora', serif;
    }

    /* â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend-row {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--ink-soft);
    }
    .legend-dot {
      width: 8px; height: 8px; border-radius: 50%;
    }
    .legend-divider {
      width: 1px;
      height: 16px;
      background: var(--border);
    }
    .status-legend {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--ink-soft);
    }
    .status-swatch {
      width: 8px; height: 8px;
      border-radius: 50%;
    }

    /* â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
    }

    /* â”€â”€ VOLUNTEER CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .vol-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
      overflow: hidden;
    }
    .vol-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      border-radius: 16px 16px 0 0;
      transition: opacity 0.2s;
      opacity: 0;
    }
    .vol-card.status-green::before  { background: var(--green); }
    .vol-card.status-yellow::before { background: var(--yellow); }
    .vol-card.status-red::before    { background: var(--red); }
    .vol-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(44,36,22,0.1);
    }
    .vol-card:hover::before { opacity: 1; }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    .vol-name {
      font-family: 'Lora', serif;
      font-size: 18px;
      font-weight: 600;
      line-height: 1.2;
    }
    .status-badge {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      padding: 3px 8px;
      border-radius: 20px;
    }
    .badge-green  { background: rgba(74,155,95,0.12);  color: var(--green); }
    .badge-yellow { background: rgba(212,160,23,0.12); color: var(--yellow); }
    .badge-red    { background: rgba(184,64,64,0.12);  color: var(--red); }

    .card-plate {
      display: flex;
      justify-content: center;
      margin-bottom: 16px;
    }

    .card-load {
      font-size: 12px;
      color: var(--ink-faint);
      text-align: center;
    }
    .card-load strong {
      color: var(--ink-soft);
    }

    /* â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .detail-panel {
      grid-column: 1 / -1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 36px;
      display: flex;
      gap: 40px;
      align-items: flex-start;
      position: relative;
      animation: expandIn 0.25s ease both;
      box-shadow: 0 4px 20px rgba(44,36,22,0.07);
    }
    @keyframes expandIn {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .detail-close {
      position: absolute; top: 20px; right: 24px;
      background: none; border: none;
      font-size: 22px; color: var(--ink-faint);
      cursor: pointer; transition: color 0.15s;
    }
    .detail-close:hover { color: var(--ink); }

    .detail-left { flex-shrink: 0; }

    .detail-right { flex-grow: 1; min-width: 0; }
    .detail-name {
      font-family: 'Lora', serif;
      font-size: 26px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .detail-meta {
      font-size: 13px;
      color: var(--ink-soft);
      margin-bottom: 28px;
    }

    .detail-section-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--ink-faint);
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
      margin-bottom: 12px;
    }

    .detail-task-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .detail-task-item:last-child { border-bottom: none; }
    .detail-task-left { display: flex; align-items: center; gap: 8px; }
    .detail-task-org {
      font-size: 11px;
      color: var(--ink-faint);
      margin-left: 2px;
    }
    .detail-task-hrs {
      font-weight: 600;
      font-size: 13px;
      color: var(--ink-soft);
    }

    .load-bar-wrap {
      margin-top: 20px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 20px;
    }
    .load-bar-label {
      font-size: 12px;
      color: var(--ink-soft);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
    }
    .load-bar-track {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }
    .load-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.4s ease;
    }

    /* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 24px;
      color: var(--ink-soft);
    }
    .empty-state p {
      font-family: 'Lora', serif;
      font-size: 18px;
      font-style: italic;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="page">

  <!-- HEADER -->
  <header class="site-header">
    <div class="logo">Volunteer<span>Flow</span></div>
    <div class="header-right">
      <div id="loading-text">Fetching data...</div>
    </div>
  </header>

  <!-- PAGE TITLE -->
  <div class="page-title">
    <h1>Your team this week</h1>
    <p>A quiet look at who's giving what â€” and what it's costing them.</p>
  </div>

  <!-- LEGEND -->
  <div class="legend-row">
    <div class="legend-item"><div class="legend-dot" style="background:var(--energizing)"></div> Energizing</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--neutral)"></div> Neutral</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--draining)"></div> Draining</div>
    <div class="legend-divider"></div>
    <div class="legend-item"><div class="status-swatch" style="background:var(--green)"></div> Doing well</div>
    <div class="legend-item"><div class="status-swatch" style="background:var(--yellow)"></div> Worth checking in</div>
    <div class="legend-item"><div class="status-swatch" style="background:var(--red)"></div> Needs attention</div>
  </div>

  <!-- GRID -->
  <div id="dashboard-grid"></div>

</div>

<script>
  // â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const firebaseConfig = {
    apiKey: "AIzaSyCIuiidzKhTKrUDEIe34jeevCelWDttA3k",
    authDomain: "chaavaruthu.firebaseapp.com",
    databaseURL: "https://chaavaruthu-default-rtdb.firebaseio.com",
    projectId: "chaavaruthu",
    storageBucket: "chaavaruthu.firebasestorage.app",
    messagingSenderId: "21044301735",
    appId: "1:21044301735:web:c81aa40d29446dc37e7082"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const colors = { energizing: "#E8874A", neutral: "#7FAF78", draining: "#5C7A9E" };
  let volunteersData = {};
  let activePanel = null;

  function getLatestWeek(weeksObj) {
    if (!weeksObj) return null;
    const dates = Object.keys(weeksObj).sort().reverse();
    return dates.length > 0 ? weeksObj[dates[0]].tasks : null;
  }

  // â”€â”€ DATA LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  db.ref('volunteers').on('value', snap => {
    const loadingEl = document.getElementById('loading-text');
    loadingEl.innerHTML = '<div class="live-dot"></div> Live';

    const grid = document.getElementById('dashboard-grid');
    grid.innerHTML = '';
    activePanel = null;

    const data = snap.val();
    if (!data) {
      grid.innerHTML = `
        <div class="empty-state">
          <p>Nothing yet â€” how's the week looking?</p>
        </div>`;
      return;
    }

    volunteersData = {};

    Object.keys(data).forEach(vid => {
      const vol = data[vid];
      const capacity = vol.profile?.capacityThreshold ?? 10;
      const latestRaw = getLatestWeek(vol.weeks);
      if (!latestRaw) return;

      const tasksArr = Array.isArray(latestRaw) ? latestRaw : Object.values(latestRaw);
      const eHrs = tasksArr.filter(t => t.tag === 'energizing').reduce((s, t) => s + t.hours, 0);
      const nHrs = tasksArr.filter(t => t.tag === 'neutral').reduce((s, t) => s + t.hours, 0);
      const dHrs = tasksArr.filter(t => t.tag === 'draining').reduce((s, t) => s + t.hours, 0);
      const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);
      const ratio = weightedLoad / capacity;

      let statusKey = 'green';
      if (ratio > 1.0) statusKey = 'red';
      else if (ratio > 0.85) statusKey = 'yellow';

      const badgeLabel = { green: 'Doing well', yellow: 'Check in', red: 'Needs attention' }[statusKey];
      volunteersData[vid] = { tasks: tasksArr, capacity, weightedLoad, ratio, statusKey };

      // Card
      const card = document.createElement('div');
      card.className = `vol-card status-${statusKey}`;
      card.dataset.vid = vid;
      card.innerHTML = `
        <div class="card-top">
          <div class="vol-name">${vid}</div>
          <div class="status-badge badge-${statusKey}">${badgeLabel}</div>
        </div>
        <div class="card-plate" id="mini-${vid}"></div>
        <div class="card-load">Load: <strong>${weightedLoad.toFixed(1)}</strong> / ${capacity}</div>
      `;

      card.addEventListener('click', () => toggleDetail(vid, card));
      grid.appendChild(card);

      drawPlateSVG(`mini-${vid}`, 70, tasksArr, capacity);
    });

    if (grid.children.length === 0) {
      grid.innerHTML = `<div class="empty-state"><p>No submissions yet this week.</p></div>`;
    }
  });

  // â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleDetail(vid, card) {
    // Remove existing panel
    document.querySelectorAll('.detail-panel').forEach(p => p.remove());
    if (activePanel === vid) { activePanel = null; return; }
    activePanel = vid;

    const { tasks: tasksArr, capacity, weightedLoad, ratio, statusKey } = volunteersData[vid];

    const panel = document.createElement('div');
    panel.className = 'detail-panel';

    // Task rows
    let tasksHtml = '';
    tasksArr.forEach(t => {
      const emoji = t.tag === 'energizing' ? 'ğŸ”¥' : t.tag === 'neutral' ? 'ğŸ˜' : 'ğŸª¨';
      tasksHtml += `
        <div class="detail-task-item">
          <div class="detail-task-left">
            <span>${emoji}</span>
            <span>${t.name || 'Unnamed'}</span>
            ${t.org ? `<span class="detail-task-org">(${t.org})</span>` : ''}
          </div>
          <span class="detail-task-hrs">${t.hours}h</span>
        </div>`;
    });

    // Load bar
    const barPct = Math.min(ratio * 100, 100);
    const barColor = statusKey === 'green' ? 'var(--green)' : statusKey === 'yellow' ? 'var(--yellow)' : 'var(--red)';

    panel.innerHTML = `
      <button class="detail-close" onclick="this.parentElement.remove(); activePanel = null;">Ã—</button>
      <div class="detail-left" id="detail-svg-${vid}"></div>
      <div class="detail-right">
        <div class="detail-name">${vid}'s week</div>
        <div class="detail-meta">Weighted load: ${weightedLoad.toFixed(1)} of ${capacity} comfortable hours</div>

        <div class="detail-section-label">Tasks logged</div>
        ${tasksHtml}

        <div class="load-bar-wrap">
          <div class="load-bar-label">
            <span>Capacity used</span>
            <span>${Math.round(ratio * 100)}%</span>
          </div>
          <div class="load-bar-track">
            <div class="load-bar-fill" style="width:${barPct}%; background:${barColor};"></div>
          </div>
        </div>
      </div>
    `;

    card.insertAdjacentElement('afterend', panel);
    setTimeout(() => drawPlateSVG(`detail-svg-${vid}`, 200, tasksArr, capacity), 10);
  }

  // â”€â”€ D3 PLATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function drawPlateSVG(containerId, size, taskData, cap) {
    const container = d3.select(`#${containerId}`);
    container.selectAll("*").remove();

    const eHrs = taskData.filter(t => t.tag === 'energizing').reduce((s, t) => s + t.hours, 0);
    const nHrs = taskData.filter(t => t.tag === 'neutral').reduce((s, t) => s + t.hours, 0);
    const dHrs = taskData.filter(t => t.tag === 'draining').reduce((s, t) => s + t.hours, 0);
    const total = eHrs + nHrs + dHrs;
    const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);

    const svg = container.append("svg")
      .attr("width", size).attr("height", size)
      .append("g").attr("transform", `translate(${size/2},${size/2})`);

    const rimRadius = size / 2 - (size > 100 ? 8 : 3);

    if (size > 100) {
      const defs = svg.append("defs");
      const filter = defs.append("filter").attr("id", `shadow-${containerId}`);
      filter.append("feDropShadow")
        .attr("dx", 0).attr("dy", 2).attr("stdDeviation", 5)
        .attr("flood-color", "rgba(44,36,22,0.1)");
      svg.append("circle").attr("r", rimRadius + 2).attr("fill", "#EDE8DF")
        .attr("filter", `url(#shadow-${containerId})`);
    }

    svg.append("circle").attr("r", rimRadius).attr("fill", "#F7F3EC");
    svg.append("circle").attr("r", rimRadius).attr("fill", "none")
      .attr("stroke", "#D4C9B5")
      .attr("stroke-width", size > 100 ? 8 : 3);

    if (total === 0) {
      svg.append("circle").attr("r", rimRadius - (size > 100 ? 10 : 2)).attr("fill", "#EDEAE3");
      if (size > 100) {
        svg.append("text")
          .attr("text-anchor", "middle").attr("dy", "5px")
          .attr("fill", "#B5A898").attr("font-size", "13px")
          .attr("font-family", "DM Sans, sans-serif")
          .text("No data");
      }
      return;
    }

    const scale = weightedLoad > cap ? 1.08 : 1.0;
    const pie = d3.pie().value(d => d.value).sort(null).padAngle(size > 100 ? 0.03 : 0.02);
    const arc = d3.arc()
      .innerRadius(size > 100 ? rimRadius * 0.12 : 0)
      .outerRadius((rimRadius - (size > 100 ? 10 : 3)) * scale)
      .cornerRadius(size > 100 ? 3 : 0);

    const drawData = [
      { label: "energizing", value: eHrs },
      { label: "neutral",    value: nHrs },
      { label: "draining",   value: dHrs }
    ];

    svg.append("g").selectAll("path")
      .data(pie(drawData)).enter().append("path")
      .attr("fill", d => colors[d.data.label])
      .attr("d", arc)
      .attr("opacity", 0.9);
  }
</script>
</body>
</html>