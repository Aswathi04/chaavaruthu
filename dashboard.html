<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your team this week</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    /* Step 2: Visual design cleanup */
    :root {
      --bg-color: #FDFAF6;
      --card-border: #EEEBE6;
      --text-main: #333333;
      --text-muted: #777777;
      --energizing: #F4A261;
      --neutral: #A8C5A0;
      --draining: #6B7FA3;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      line-height: 1.7;
      padding: 40px 20px;
    }

    h1, h2, h3 { font-weight: 800; line-height: 1.2; margin-bottom: 16px; }
    h1 { font-size: 28px; }

    .container { max-width: 1000px; margin: 0 auto; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 24px;
    }

    .card {
      background-color: #FFFFFF;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.2s;
      position: relative;
    }
    .card:hover { transform: translateY(-2px); }

    .status-dot {
      width: 12px; height: 12px; border-radius: 50%;
      position: absolute; top: 24px; right: 24px;
    }
    .dot-green { background-color: #4CAF50; }
    .dot-yellow { background-color: #FFC107; }
    .dot-red { background-color: #F44336; }

    /* Inline Expansion Panel */
    .detail-panel {
      grid-column: 1 / -1;
      background-color: #FFFFFF;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      gap: 32px;
      align-items: flex-start;
    }
    .detail-plate { flex-shrink: 0; }
    .detail-info { flex-grow: 1; }
    .detail-tasks { margin-top: 16px; font-size: 14px; }
    .task-item { border-bottom: 1px solid #F5F5F5; padding: 8px 0; display: flex; justify-content: space-between; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid var(--card-border); padding-bottom: 16px; margin-bottom: 32px;">
      <h1>Your team this week</h1>
      <p id="loading-text" style="color: var(--text-muted);">Fetching data...</p>
    </div>

    <div id="dashboard-grid" class="grid"></div>
  </div>

  <script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
    apiKey: "AIzaSyCIuiidzKhTKrUDEIe34jeevCelWDttA3k",
    authDomain: "chaavaruthu.firebaseapp.com",
    databaseURL: "https://chaavaruthu-default-rtdb.firebaseio.com",
    projectId: "chaavaruthu",
    storageBucket: "chaavaruthu.firebasestorage.app",
    messagingSenderId: "21044301735",
    appId: "1:21044301735:web:c81aa40d29446dc37e7082",
    measurementId: "G-18BY8VY06N"
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const colors = { energizing: "#F4A261", neutral: "#A8C5A0", draining: "#6B7FA3" };
    let volunteersData = {};

    function getLatestWeek(weeksObj) {
      if (!weeksObj) return null;
      const dates = Object.keys(weeksObj).sort().reverse();
      return dates.length > 0 ? weeksObj[dates[0]].tasks : null;
    }

    db.ref('volunteers').on('value', snap => {
      document.getElementById('loading-text').innerText = "Live";
      const grid = document.getElementById('dashboard-grid');
      grid.innerHTML = '';
      
      const data = snap.val();
      if (!data) {
        grid.innerHTML = '<p style="color: var(--text-muted);">Nothing yet ‚Äî how\'s the week looking?</p>';
        return;
      }

      volunteersData = {};

      Object.keys(data).forEach(vid => {
        const vol = data[vid];
        const capacity = (vol.profile && vol.profile.capacityThreshold) ? vol.profile.capacityThreshold : 10;
        const latestTasks = getLatestWeek(vol.weeks);
        
        if (!latestTasks) return; // Skip if no task history at all

        const tasksArr = Object.values(latestTasks);
        const eHrs = tasksArr.filter(t => t.tag === 'energizing').reduce((s,t) => s+t.hours, 0);
        const nHrs = tasksArr.filter(t => t.tag === 'neutral').reduce((s,t) => s+t.hours, 0);
        const dHrs = tasksArr.filter(t => t.tag === 'draining').reduce((s,t) => s+t.hours, 0);
        
        const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);
        const ratio = weightedLoad / capacity;
        
        let statusClass = 'dot-green';
        if (ratio > 1.0) statusClass = 'dot-red';
        else if (ratio > 0.85) statusClass = 'dot-yellow';

        volunteersData[vid] = { tasks: tasksArr, capacity, weightedLoad, ratio };

        // Create Card
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="status-dot ${statusClass}"></div>
          <h2 style="font-size: 18px; margin-bottom: 16px;">${vid}</h2>
          <div id="mini-${vid}" style="display: flex; justify-content: center;"></div>
        `;
        
        // Handle Expansion
        card.addEventListener('click', () => {
          document.querySelectorAll('.detail-panel').forEach(p => p.remove());
          
          const panel = document.createElement('div');
          panel.className = 'detail-panel';
          
          let tasksHtml = '';
          tasksArr.forEach(t => {
            const emoji = t.tag === 'energizing' ? 'üî•' : t.tag === 'neutral' ? 'üòê' : 'ü™®';
            tasksHtml += `<div class="task-item"><span>${emoji} ${t.name} <span style="color: #999; font-size: 12px;">(${t.org})</span></span> <strong>${t.hours}h</strong></div>`;
          });

          panel.innerHTML = `
            <div class="detail-plate" id="detail-svg-${vid}"></div>
            <div class="detail-info">
              <h2 style="margin-bottom: 4px;">${vid}'s Week</h2>
              <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 24px;">Weighted Load: ${weightedLoad.toFixed(1)} / Capacity: ${capacity}</p>
              <h3 style="font-size: 14px; text-transform: uppercase; color: #999; border-bottom: 1px solid #EEE; padding-bottom: 8px;">Tasks Logged</h3>
              <div class="detail-tasks">${tasksHtml}</div>
            </div>
            <button onclick="this.parentElement.remove()" style="background:none; border:none; font-size: 24px; color: #CCC; cursor: pointer; position: absolute; right: 24px; top: 24px;">√ó</button>
          `;
          
          card.insertAdjacentElement('afterend', panel);
          drawPlateSVG(`detail-svg-${vid}`, 200, tasksArr, capacity);
        });

        grid.appendChild(card);
        drawPlateSVG(`mini-${vid}`, 60, tasksArr, capacity);
      });
    });

    // --- D3 PLATE RENDERER (Shared logic) ---
    function drawPlateSVG(containerId, size, taskData, cap) {
      const container = d3.select(`#${containerId}`);
      container.selectAll("*").remove();

      const eHrs = taskData.filter(t => t.tag === 'energizing').reduce((s,t) => s+t.hours, 0);
      const nHrs = taskData.filter(t => t.tag === 'neutral').reduce((s,t) => s+t.hours, 0);
      const dHrs = taskData.filter(t => t.tag === 'draining').reduce((s,t) => s+t.hours, 0);
      const weightedLoad = (dHrs * 1.5) + (nHrs * 1.0) + (eHrs * 0.75);

      const svg = container.append("svg")
        .attr("width", size).attr("height", size)
        .append("g").attr("transform", `translate(${size/2},${size/2})`);

      const radius = size / 2;
      const rimRadius = radius - (size > 100 ? 10 : 4);

      svg.append("circle").attr("r", rimRadius).attr("fill", "none").attr("stroke", "#E8E3DC").attr("stroke-width", size > 100 ? 8 : 4);

      const scale = weightedLoad > cap ? 1.1 : 1.0;
      const pie = d3.pie().value(d => d.value).sort(null);
      const arc = d3.arc().innerRadius(0).outerRadius((rimRadius - (size > 100 ? 4 : 2)) * scale);

      const drawData = [{ label: "energizing", value: eHrs }, { label: "neutral", value: nHrs }, { label: "draining", value: dHrs }];

      svg.append("g").selectAll("path").data(pie(drawData)).enter().append("path")
        .attr("fill", d => colors[d.data.label])
        .attr("d", arc);
    }
  </script>
</body>
</html>